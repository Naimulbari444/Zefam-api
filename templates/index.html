<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Service TikTok Bot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #080808; color: #fff; font-family: 'Inter', sans-serif; padding: 15px; }
        .container-main { max-width: 450px; margin: auto; background: #121212; padding: 25px; border-radius: 20px; border: 1px solid #222; box-shadow: 0 15px 35px rgba(0,0,0,0.7); }
        h3 { color: #00ff88; text-align: center; font-weight: 800; letter-spacing: 1px; margin-bottom: 25px; }
        label { color: #888; font-size: 11px; font-weight: 700; text-transform: uppercase; margin-bottom: 8px; display: block; }
        .form-control, .form-select { background: #1a1a1a !important; border: 1px solid #333 !important; color: #fff !important; padding: 12px; border-radius: 12px; margin-bottom: 20px; }
        .form-control::placeholder { color: #555 !important; }
        .btn-start { background: #00ff88; color: #000; font-weight: 700; width: 100%; padding: 14px; border-radius: 12px; border: none; transition: 0.3s; }
        .btn-start:hover { background: #00cc6e; transform: translateY(-2px); }
        .btn-stop { background: #ff3333; color: #fff; font-weight: 700; width: 100%; padding: 12px; border-radius: 12px; border: none; margin-top: 10px; }
        .log-box { background: #000; color: #00ff88; height: 250px; overflow-y: auto; border: 1px solid #222; padding: 15px; font-family: 'Consolas', monospace; font-size: 11px; border-radius: 12px; margin-top: 20px; border-left: 3px solid #00ff88; }
        .stat-bar { background: #1a1a1a; padding: 10px; border-radius: 10px; text-align: center; margin-bottom: 20px; border: 1px solid #222; font-size: 13px; }
    </style>
</head>
<body>

<div class="container-main">
    <h3>TIKTOK MULTI-BOT</h3>
    <div class="stat-bar">Active Running Tasks: <span id="t-count" class="text-info fw-bold">0</span></div>

    <form id="botForm">
        <label>Service Type</label>
        <select id="sid" class="form-select">
            {% for s in services %}
            <option value="{{ s.id }}" {% if not s.is_ok %}class="text-danger"{% endif %}>
                {{ s.name }} — [{{ s.status }}]
            </option>
            {% endfor %}
        </select>

        <label>TikTok Video Link</label>
        <input type="url" id="link" class="form-control" placeholder="https://www.tiktok.com/@user/video/..." required>

        <label>Target Amount</label>
        <input type="number" id="trgt" class="form-control" placeholder="Enter amount (e.g. 500)">

        <button type="submit" class="btn-start">ADD TO QUEUE</button>
    </form>
    
    <button onclick="stopAll()" class="btn-stop">STOP ALL PROCESSES</button>

    <div id="logs" class="log-box">> System ready. Select a service to start.</div>
</div>

<script>
    async function refreshLogs() {
        try {
            const res = await fetch('/get_logs');
            const data = await res.json();
            const logDiv = document.getElementById('logs');
            logDiv.innerHTML = data.logs.map(l => `<div>${l}</div>`).join('');
            logDiv.scrollTop = logDiv.scrollHeight;
            document.getElementById('t-count').innerText = data.running_count;
        } catch (e) {}
    }

    document.getElementById('botForm').onsubmit = async (e) => {
        e.preventDefault();
        const sel = document.getElementById('sid');
        const fd = new FormData();
        fd.append('service_id', sel.value);
        fd.append('service_name', sel.options[sel.selectedIndex].text.split(' — ')[0]);
        fd.append('video_link', document.getElementById('link').value);
        fd.append('target', document.getElementById('trgt').value);
        
        const r = await fetch('/start', { method: 'POST', body: fd });
        const res = await r.json();
        if(res.status === "already_running") {
            alert("This service is already in progress!");
        } else {
            refreshLogs();
        }
    };

    async function stopAll() {
        if(confirm("Are you sure you want to stop all active tasks?")) {
            await fetch('/stop_all', { method: 'POST' });
            setTimeout(refreshLogs, 500);
        }
    }

    setInterval(refreshLogs, 3000);
</script>
</body>
</html>
